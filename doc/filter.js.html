<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: filter.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: filter.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>// user msg cache
let spamCache = {}

/**
 * Filter - Filters messages recieved by the bot. Filters can be set in {@link bot#config config.js}. Also filters spam messages.
 *
 * @param  {BraniacClient} bot The bot client.
 * @param  {Discord.Message} msg The message to filter.
 */
module.exports = function (bot, msg) {
  if (!bot.config[msg.guild.id]) return
  // messages to delete
  let delCache = []
  // get useful info
  let author = msg.author
  let content = msg.content.toLowerCase()
  let createdTimestamp = msg.createdTimestamp
  /*
  *
  * Filter messages
  *
  */
  // Filters in the config
  let filterGroups = bot.config[msg.guild.id].filters
  // Loop through filter groups
  Object.values(filterGroups).forEach(filterGroup => {
    // Loop through filters
    filterGroup.filters.forEach(rawFilter => {
      // If the filter isn't a RegExp object/literal, make it one
      let filter = typeof rawFilter === 'object'
        ? new RegExp(rawFilter, 'g')
        : rawFilter
      // Get results of matches
      let results = filter.exec(content)
      // Skip to the next filter if this one isn't triggered
      if (!results) return

      // Perform the preset action
      switch (filterGroup.action) {
        case 'warn':
          // Warn the user, and delete the warning after 10 seconds
          msg.reply('your message triggered a filter. Be careful...')
            .then(m => m.delete(10000).catch(console.error))
            .catch(console.error)
          break

        case 'delete':
          // Cache the message to be deleted
          if (!delCache.includes(msg)) delCache.push(msg)
          break

        default:
      }
    })
  })
  /*
  *
  * Spam
  *
  */
  // The interval between messages to count as spam (in ms)
  let spamTime = bot.config[msg.guild.id].spamTime
  // The time between this message and the user's last (-999 if first)
  let time = spamCache[author.id] ? createdTimestamp - spamCache[author.id] : -999

  // If the message is spam
  if (time !== -999 &amp;&amp; time &lt;= spamTime) {
    // Cache the message to be deleted
    if (!delCache.includes(msg)) delCache.push(msg)
  }
  // Set the user's updated last message time
  spamCache[author.id] = createdTimestamp
  /*
  *
  * Delete
  *
  */
  // Delete every message in the cache, with a pause cos ratelimits
  delCache.forEach(message => {
    setTimeout(() => {
      message.delete().catch(console.error)
    }, 50)
  })
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="BraniacClient.html">BraniacClient</a></li><li><a href="BraniacCommand.html">BraniacCommand</a></li><li><a href="Logger.html">Logger</a></li></ul><h3>Namespaces</h3><ul><li><a href="Braniac.html">Braniac</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.4.3</a> on Sun Aug 20 2017 17:44:01 GMT+1200 (New Zealand Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
